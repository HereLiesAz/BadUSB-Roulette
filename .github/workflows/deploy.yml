name: Deploy System (Unified)

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - 'firmware/**' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      # --- SETUP ---
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install Digispark Core
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/digistump/arduino-boards-index/master/package_digistump_index.json
          arduino-cli core update-index
          arduino-cli core install digistump:avr

      # --- BUILD ---
      - name: Compile Firmware & Fetch Driver
        run: |
          # 1. Clean Inventory
          mkdir -p firmware
          rm -f firmware/*.hex
          rm -f firmware/*.js
          echo "Inventory Cleared."

          # 2. DOWNLOAD DRIVER (Self-Hosting)
          echo ">>> ACQUIRING DRIVER..."
          curl -L -o firmware/micronucleus.js https://raw.githubusercontent.com/skandhurkat/micronucleus-web/master/lib/micronucleus.js
          
          # Verify Driver
          if [ -s "firmware/micronucleus.js" ]; then
            echo "Driver Acquired Successfully."
          else
            echo "CRITICAL: Failed to download driver."
            exit 1
          fi

          # 3. Compile SINGLE LED
          echo ">>> COMPILING SINGLE LED..."
          mkdir -p build/single_env/Sketch
          cp TheRevolver.ino build/single_env/Sketch/Sketch.ino
          cp roulette_cfg.h build/single_env/Sketch/roulette_cfg.h
          
          sed -i 's/#define DUAL_LED_MODE 1/#define DUAL_LED_MODE 0/' build/single_env/Sketch/roulette_cfg.h
          
          arduino-cli compile --fqbn digistump:avr:digispark-tiny --output-dir ./build/single build/single_env/Sketch
          
          if [ -f "./build/single/Sketch.ino.hex" ]; then
            cp "./build/single/Sketch.ino.hex" "./firmware/roulette_single.hex"
          else
            echo "CRITICAL: Single Hex Failed to Build"
            exit 1
          fi

          # 4. Compile DUAL LED
          echo ">>> COMPILING DUAL LED..."
          mkdir -p build/dual_env/Sketch
          cp TheRevolver.ino build/dual_env/Sketch/Sketch.ino
          cp roulette_cfg.h build/dual_env/Sketch/roulette_cfg.h
          
          sed -i 's/#define DUAL_LED_MODE 0/#define DUAL_LED_MODE 1/' build/dual_env/Sketch/roulette_cfg.h
          
          arduino-cli compile --fqbn digistump:avr:digispark-tiny --output-dir ./build/dual build/dual_env/Sketch
          
          if [ -f "./build/dual/Sketch.ino.hex" ]; then
            cp "./build/dual/Sketch.ino.hex" "./firmware/roulette_dual.hex"
          else
            echo "CRITICAL: Dual Hex Failed to Build"
            exit 1
          fi

      # --- COMMIT BACK ---
      - name: Commit Artifacts
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add firmware/*
          git diff --quiet && git diff --staged --quiet || (git commit -m "Reload: Updated Firmware & Driver [skip ci]" && git push)

      # --- DEPLOY SITE ---
      - name: Stage & Deploy Website
        run: |
          mkdir -p public
          cp index.html public/index.html
          cp -r firmware public/firmware
          touch public/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          commit_message: "Deploy: Unified Release"

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BADUSB ROULETTE</title>
  <script src="https://cdn.jsdelivr.net/gh/skandhurkat/micronucleus-web@master/lib/micronucleus.js"></script>
  <style>
    :root {
      --bg-color: #050505;
      --term-green: #00ff41;
      --term-dim: #008f11;
      --alert-red: #ff0000;
      --panel-bg: #0a0a0a;
      --border-color: #333;
    }

    /* --- BASE LAYOUT --- */
    body {
      background-color: var(--bg-color);
      color: var(--term-green);
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* --- SCANLINES --- */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      z-index: 2;
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
    }

    /* --- HEADER --- */
    header {
      width: 100%;
      padding: 40px 0;
      text-align: center;
      border-bottom: 2px solid var(--term-dim);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 3rem;
      letter-spacing: 10px;
      margin: 0;
      text-shadow: 0 0 10px var(--term-green);
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 1rem;
      color: var(--term-dim);
      letter-spacing: 2px;
      margin-top: 10px;
    }

    /* --- WINDOWS ALERT --- */
    #winWarning {
      display: none; /* Toggled by JS */
      width: 95%;
      max-width: 800px;
      border: 2px solid var(--alert-red);
      background: rgba(20, 0, 0, 0.8);
      margin-bottom: 30px;
      text-align: center;
      color: var(--alert-red);
      padding: 15px;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
    }

    .warning-header {
      font-weight: bold;
      letter-spacing: 2px;
      border-bottom: 1px solid var(--alert-red);
      padding-bottom: 10px;
      margin-bottom: 10px;
      font-size: 1.2rem;
    }

    .warning-content {
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .warning-content a {
      color: #fff;
      font-weight: bold;
      text-decoration: underline;
      cursor: pointer;
    }
    
    .warning-content a:hover {
      color: var(--term-green);
    }

    /* --- ARMORY --- */
    .armory-controls {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    select {
      background: #000;
      color: var(--term-green);
      border: 1px solid var(--term-green);
      padding: 10px;
      font-family: inherit;
      text-transform: uppercase;
      cursor: pointer;
    }

    /* Custom File Upload */
    .file-upload {
      border: 1px dashed var(--term-dim);
      padding: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      color: #666;
    }
    .file-upload:hover { border-color: var(--term-green); color: var(--term-green); }
    input[type="file"] { display: none; }

    /* Mutation Controls inside headers */
    .mutation-select {
      font-size: 0.7rem;
      padding: 2px 5px;
      border: 1px solid #333;
      color: #666;
    }
    .mutation-select:hover { border-color: var(--term-green); color: var(--term-green); }

    .chamber-grid {
      display: flex;
      gap: 20px;
      width: 95%;
      max-width: 1600px;
      flex: 1;
      margin-bottom: 40px;
    }

    .chamber {
      flex: 1;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: 0.3s;
      position: relative;
    }

    .chamber:hover {
      border-color: var(--term-green);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
    }

    .chamber-header {
      background: #111;
      border-bottom: 1px solid #333;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      letter-spacing: 2px;
    }

    textarea {
      flex: 1;
      background: #000;
      color: #aaa;
      border: none;
      padding: 15px;
      resize: none;
      font-family: 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.4;
      outline: none;
      min-height: 400px;
    }

    textarea:focus { color: #fff; background: #080808; }

    /* --- TRIGGER --- */
    .trigger-zone { width: 100%; text-align: center; padding-bottom: 30px; }
    
    button#burnBtn {
      background: #000;
      color: var(--term-green);
      border: 2px solid var(--term-green);
      padding: 20px 60px;
      font-size: 1.5rem;
      letter-spacing: 5px;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.2s;
    }

    button#burnBtn:hover {
      background: var(--term-green);
      color: #000;
      box-shadow: 0 0 30px var(--term-green);
    }

    /* --- CONSOLE --- */
    .console-wrapper {
      width: 95%;
      max-width: 1600px;
      background: #000;
      border: 1px solid var(--term-dim);
      margin-bottom: 50px;
    }
    .console-header {
      background: var(--panel-bg);
      border-bottom: 1px solid var(--term-dim);
      padding: 5px 10px;
      font-size: 0.8rem;
      color: var(--term-dim);
      letter-spacing: 2px;
    }
    #log {
      height: 200px;
      overflow-y: scroll;
      padding: 10px;
      font-family: 'Consolas', monospace;
      font-size: 0.9rem;
      color: #888;
    }
    .log-line { margin-bottom: 2px; }
    .log-err { color: var(--alert-red); }
    .log-ok { color: var(--term-green); }
    .log-warn { color: #ff0; }
  </style>
</head>
<body>

  <header>
    <h1>BadUSB Roulette</h1>
    <div class="subtitle">/// UNIFIED PAYLOAD FABRICATION SYSTEM ///</div>
  </header>

  <div id="winWarning">
    <div class="warning-header">/// ENVIRONMENT WARNING: WINDOWS DETECTED ///</div>
    <div class="warning-content">
      CRITICAL DRIVER MISMATCH LIKELY.<br>
      WEBUSB REQUIRES THE <strong>WinUSB</strong> DRIVER.<br><br>
      <div style="text-align: left; display: inline-block;">
        1. <a href="https://zadig.akeo.ie/" target="_blank">DOWNLOAD ZADIG</a><br>
        2. CONNECT DIGISPARK<br>
        3. OPTIONS > 'LIST ALL DEVICES'<br>
        4. SELECT 'DIGISPARK BOOTLOADER'<br>
        5. REPLACE DRIVER WITH <strong>WinUSB</strong>
      </div>
    </div>
  </div>

  <div class="armory-controls">
    <label>HARDWARE CONFIGURATION:</label>
    <select id="hwModel">
      <option value="roulette_single.hex">SINGLE LED (MODEL A / REV 2)</option>
      <option value="roulette_dual.hex">DUAL LED (MODEL B / REV 1)</option>
    </select>
    
    <label class="file-upload">
      [ MANUAL OVERRIDE: LOAD .HEX ]
      <input type="file" id="customHex" accept=".hex">
    </label>
  </div>

  <div class="chamber-grid">
    <div class="chamber">
      <div class="chamber-header">
        CHAMBER 01
        <select class="mutation-select" onchange="mutate(this, 'c1')">
          <option value="" disabled selected>MUTATE...</option>
          <option value="WIN">TO WINDOWS</option>
          <option value="MAC">TO MAC</option>
          <option value="LINUX">TO LINUX</option>
          <option value="ANDROID">TO ANDROID</option>
          <option value="IOS">TO IOS</option>
        </select>
      </div>
      <textarea id="c1" placeholder="// WINDOWS PAYLOAD&#10;DELAY 1000&#10;GUI r&#10;DELAY 200&#10;STRING notepad&#10;ENTER"></textarea>
    </div>
    <div class="chamber">
      <div class="chamber-header">
        CHAMBER 02
        <select class="mutation-select" onchange="mutate(this, 'c2')">
          <option value="" disabled selected>MUTATE...</option>
          <option value="WIN">TO WINDOWS</option>
          <option value="MAC">TO MAC</option>
          <option value="LINUX">TO LINUX</option>
          <option value="ANDROID">TO ANDROID</option>
          <option value="IOS">TO IOS</option>
        </select>
      </div>
      <textarea id="c2" placeholder="// MAC PAYLOAD&#10;DELAY 1000&#10;GUI SPACE&#10;DELAY 200&#10;STRING Terminal&#10;ENTER"></textarea>
    </div>
    <div class="chamber">
      <div class="chamber-header">
        CHAMBER 03
        <select class="mutation-select" onchange="mutate(this, 'c3')">
          <option value="" disabled selected>MUTATE...</option>
          <option value="WIN">TO WINDOWS</option>
          <option value="MAC">TO MAC</option>
          <option value="LINUX">TO LINUX</option>
          <option value="ANDROID">TO ANDROID</option>
          <option value="IOS">TO IOS</option>
        </select>
      </div>
      <textarea id="c3" placeholder="// LINUX PAYLOAD&#10;DELAY 1000&#10;GUI&#10;DELAY 200&#10;STRING firefox&#10;ENTER"></textarea>
    </div>
  </div>

  <div class="trigger-zone">
    <button id="burnBtn">FLASH FIRMWARE</button>
  </div>

  <div class="console-wrapper">
    <div class="console-header">/// SYSTEM OUTPUT ///</div>
    <div id="log"></div>
  </div>

<script>
// ENVIRONMENT CHECK
if (navigator.userAgent.indexOf("Win") != -1) {
  document.getElementById('winWarning').style.display = 'block';
}

function logMsg(msg, type='normal') {
  const logEl = document.getElementById('log');
  const line = document.createElement('div');
  line.className = 'log-line ' + (type === 'error' ? 'log-err' : type === 'success' ? 'log-ok' : '');
  line.innerText = `[${new Date().toLocaleTimeString('en-US',{hour12:false})}] ${msg}`;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

const KEY_MAP = {
  'ENTER':0x28, 'ESC':0x29, 'BACKSPACE':0x2A, 'TAB':0x2B, 'SPACE':0x2C, 'MINUS':0x2D, 
  'EQUAL':0x2E, 'LEFT_BRACE':0x2F, 'RIGHT_BRACE':0x30, 'BACKSLASH':0x31, 'SEMICOLON':0x33, 
  'QUOTE':0x34, 'GRAVE':0x35, 'COMMA':0x36, 'PERIOD':0x37, 'SLASH':0x38, 'CAPS_LOCK':0x39, 
  'F1':0x3A, 'F2':0x3B, 'F3':0x3C, 'F4':0x3D, 'F5':0x3E, 'F6':0x3F, 'F7':0x40, 'F8':0x41, 
  'F9':0x42, 'F10':0x43, 'F11':0x44, 'F12':0x45, 'PRINTSCREEN':0x46, 'SCROLL_LOCK':0x47, 
  'PAUSE':0x48, 'INSERT':0x49, 'HOME':0x4A, 'PAGE_UP':0x4B, 'DELETE':0x4C, 'END':0x4D, 
  'PAGE_DOWN':0x4E, 'RIGHT':0x4F, 'LEFT':0x50, 'DOWN':0x51, 'UP':0x52, 'GUI':0xE3, 'WINDOWS':0xE3,
  'COMMAND':0xE3, 'SHIFT':0xE1, 'ALT':0xE2, 'CTRL':0xE0
};

const ASCII_MAP = {
  'a':0x04,'b':0x05,'c':0x06,'d':0x07,'e':0x08,'f':0x09,'g':0x0A,'h':0x0B,'i':0x0C,'j':0x0D,
  'k':0x0E,'l':0x0F,'m':0x10,'n':0x11,'o':0x12,'p':0x13,'q':0x14,'r':0x15,'s':0x16,'t':0x17,
  'u':0x18,'v':0x19,'w':0x1A,'x':0x1B,'y':0x1C,'z':0x1D,'1':0x1E,'2':0x1F,'3':0x20,'4':0x21,
  '5':0x22,'6':0x23,'7':0x24,'8':0x25,'9':0x26,'0':0x27,' ':0x2C
};

/* --- MUTATION ENGINE --- */
function mutate(selector, targetId) {
  const mode = selector.value;
  const area = document.getElementById(targetId);
  let script = area.value;
  
  if (!script) return;
  logMsg(`MUTATING CHAMBER ${targetId.toUpperCase()} TO ${mode}...`, 'warn');

  // NORMALIZE
  script = script
    .replace(/GUI r\b/gi, '###RUN###')        // Win
    .replace(/GUI SPACE\b/gi, '###RUN###')    // Mac/iOS
    .replace(/ALT F2\b/gi, '###RUN###')       // Linux
    .replace(/COMMAND\b/gi, '###GUI###')      // Mac
    .replace(/WINDOWS\b/gi, '###GUI###')      // Win
    .replace(/GUI\b/gi, '###GUI###');         // Generic

  // APPLY
  switch(mode) {
    case 'WIN':
      script = script.replace(/###RUN###/g, 'GUI r').replace(/###GUI###/g, 'GUI').replace(/OPTION\b/gi, 'ALT');
      break;
    case 'MAC':
      script = script.replace(/###RUN###/g, 'GUI SPACE').replace(/###GUI###/g, 'COMMAND').replace(/ALT\b/gi, 'OPTION').replace(/CTRL\b/gi, 'COMMAND'); 
      break;
    case 'LINUX':
      script = script.replace(/###RUN###/g, 'ALT F2').replace(/###GUI###/g, 'GUI').replace(/COMMAND\b/gi, 'CTRL').replace(/OPTION\b/gi, 'ALT');
      break;
    case 'ANDROID':
      script = script.replace(/###RUN###/g, 'GUI b').replace(/###GUI###/g, 'GUI');
      break;
    case 'IOS':
      script = script.replace(/###RUN###/g, 'GUI SPACE').replace(/###GUI###/g, 'COMMAND');
      break;
  }
  area.value = script;
  selector.selectedIndex = 0; 
}

function compileDucky(script) {
  const bytes = [];
  const lines = script.split('\n');
  for (let line of lines) {
    line = line.trim();
    if (!line || line.startsWith("REM") || line.startsWith("//") || line.startsWith("#")) continue;
    
    const parts = line.split(' ');
    const cmd = parts[0].toUpperCase();
    const args = parts.slice(1).join(' ');

    if (cmd === 'DELAY') {
      const ms = parseInt(args);
      bytes.push(0x01, (ms >> 8) & 0xFF, ms & 0xFF);
    } 
    else if (cmd === 'STRING') {
      for (let i = 0; i < args.length; i += 255) {
        const chunk = args.substring(i, Math.min(i + 255, args.length));
        bytes.push(0x03, chunk.length); 
        for (let c = 0; c < chunk.length; c++) bytes.push(chunk.charCodeAt(c));
      }
    }
    else if (cmd === 'GUI' || cmd === 'WINDOWS' || cmd === 'COMMAND') {
      let key = 0;
      if (args && ASCII_MAP[args.toLowerCase()]) key = ASCII_MAP[args.toLowerCase()]; 
      else if (args && KEY_MAP[args.toUpperCase()]) key = KEY_MAP[args.toUpperCase()];
      bytes.push(0x02, 0x08, key); 
    }
    else if (KEY_MAP[cmd]) { 
      bytes.push(0x02, 0x00, KEY_MAP[cmd]); 
    }
  }
  bytes.push(0x00); 
  return bytes;
}

function patchHex(hexString, payloadData) {
  const buffer = new Uint8Array(8192).fill(0xFF); 
  const lines = hexString.split('\n');
  for (let line of lines) {
    line = line.trim();
    if (line[0] !== ':') continue;
    const len = parseInt(line.substr(1, 2), 16);
    const addr = parseInt(line.substr(3, 4), 16);
    const type = parseInt(line.substr(7, 2), 16);
    if (type === 0) { 
      for (let i = 0; i < len; i++) { buffer[addr + i] = parseInt(line.substr(9 + i * 2, 2), 16); }
    }
  }

  let magicIdx = -1;
  for (let i = 0; i < buffer.length - 4; i++) {
    if (buffer[i]===0xCA && buffer[i+1]===0xFE && buffer[i+2]===0xBA && buffer[i+3]===0xBE) {
      magicIdx = i; break;
    }
  }
  if (magicIdx === -1) throw new Error("TEMPLATE INVALID: MAGIC HEADER NOT FOUND");

  let currentOffset = 10;
  function inject(payload, offH_idx, offL_idx) {
    if (payload.length <= 1) { 
      buffer[magicIdx + offH_idx] = 0x00;
      buffer[magicIdx + offL_idx] = 0x00;
      return; 
    }
    if (magicIdx + currentOffset + payload.length >= buffer.length) throw new Error("PAYLOAD TOO LARGE - FLASH OVERFLOW");

    buffer[magicIdx + offH_idx] = (currentOffset >> 8) & 0xFF;
    buffer[magicIdx + offL_idx] = (currentOffset) & 0xFF;
    let writePtr = magicIdx + currentOffset;
    for(let b of payload) buffer[writePtr++] = b;
    currentOffset += payload.length;
  }

  inject(payloadData.c1, 4, 5);
  inject(payloadData.c2, 6, 7);
  inject(payloadData.c3, 8, 9);
  return buffer;
}

/* --- TELEMETRY & AMMUNITION LOGIC --- */

// 1. Manual Override
let customHexData = null;
document.getElementById('customHex').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (file) {
    customHexData = await file.text();
    logMsg(`MANUAL OVERRIDE: LOADED ${file.name}`, 'warn');
  }
});

// 2. Factory Radar (The Progress Monitor)
async function monitorFactory(user, repo) {
  let attempts = 0;
  const maxAttempts = 24; // 2 minutes (24 * 5s)
  
  while (attempts < maxAttempts) {
    try {
      const api = `https://api.github.com/repos/${user}/${repo}/actions/runs?per_page=1`;
      const resp = await fetch(api);
      
      if (resp.status === 403) {
        logMsg("RADAR JAMMED (API RATE LIMIT). WAIT BLINDLY...", 'error');
        await new Promise(r => setTimeout(r, 10000));
        attempts++;
        continue;
      }
      
      const data = await resp.json();
      if (data.workflow_runs && data.workflow_runs.length > 0) {
        const run = data.workflow_runs[0];
        
        if (run.status === 'queued') {
          logMsg(`FACTORY: JOB QUEUED [${run.name}]...`, 'warn');
        } else if (run.status === 'in_progress') {
          logMsg(`FACTORY: FORGING AMMO [${run.name}]...`, 'warn');
        } else if (run.status === 'completed' && run.conclusion === 'success') {
          logMsg(`FACTORY: SHIPMENT CONFIRMED. RE-ACQUIRING TARGET...`, 'success');
          return true; // Success! Break loop and retry fetch
        } else if (run.status === 'completed' && run.conclusion === 'failure') {
          logMsg(`FACTORY: BUILD FAILED. ABORTING.`, 'error');
          return false;
        }
      }
    } catch (e) {
      console.log("Radar glitch", e);
    }
    
    // Wait 5 seconds before next ping
    await new Promise(r => setTimeout(r, 5000));
    attempts++;
  }
  
  logMsg("RADAR TIMEOUT. FACTORY UNRESPONSIVE.", 'error');
  return false;
}

// 3. Remote Fetcher with Radar Integration
async function fetchTemplate(filename) {
  // A. Check for Manual Override
  if (customHexData) {
    logMsg("USING MANUAL OVERRIDE DATA...", 'warn');
    return customHexData;
  }

  const cacheBust = "?t=" + new Date().getTime();
  const firmPath = `firmware/${filename}${cacheBust}`;

  try {
    // Try Bunker First
    logMsg(`CHECKING BUNKER: ${firmPath}`, 'warn');
    let resp = await fetch(firmPath);
    if (resp.ok) return await resp.text();
    
    throw new Error(resp.status);

  } catch (e) {
    logMsg(`BUNKER EMPTY (${e.message}). SCANNING FACTORY...`, 'warn');
    
    // Auto-detect User/Repo
    let user = 'hereliesaz';
    let repo = 'BadUSB-Roulette';
    const hostname = window.location.hostname;
    const pathname = window.location.pathname;
    if (hostname.includes('github.io')) {
       user = hostname.split('.')[0];
       repo = pathname.split('/')[1] || repo;
    }

    // ENGAGE RADAR
    const factorySuccess = await monitorFactory(user, repo);
    
    if (factorySuccess) {
      // Retry Fetch
      logMsg("RETRYING BUNKER ACCESS...", 'warn');
      let resp = await fetch(firmPath);
      if (resp.ok) return await resp.text();
    }
    
    throw new Error("UNABLE TO ACQUIRE FIRMWARE");
  }
}

document.getElementById('burnBtn').addEventListener('click', async () => {
  const hw = document.getElementById('hwModel').value;
  try {
    if (!navigator.usb) throw new Error("WEBUSB NOT SUPPORTED (USE CHROME/EDGE)");
    
    logMsg("COMPILING...");
    const payloads = {
      c1: compileDucky(document.getElementById('c1').value),
      c2: compileDucky(document.getElementById('c2').value),
      c3: compileDucky(document.getElementById('c3').value)
    };
    
    const hexText = await fetchTemplate(hw);
    
    const firmBuffer = patchHex(hexText, payloads);
    
    logMsg("SEARCHING FOR DIGISPARK... (PLUG IN NOW)");
    const device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x16d0, productId: 0x0753 }] });
    const client = new Micronucleus(device);
    
    logMsg("FLASHING...", 'warn');
    await client.upload(firmBuffer);
    logMsg("COMPLETE. DISCONNECT.", 'success');
    
  } catch (e) {
    logMsg("ERROR: " + e.message, 'error');
  }
});
</script>
</body>
</html>

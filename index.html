<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ROULETTE ARMORY // AUTHORIZED PERSONNEL ONLY</title>
  <script src="https://cdn.jsdelivr.net/gh/skandhurkat/micronucleus-web@master/lib/micronucleus.js"></script>
  <style>
    :root {
      --bg-color: #050505;
      --term-green: #00ff41;
      --term-dim: #008f11;
      --alert-red: #ff0000;
      --panel-bg: #0a0a0a;
      --border-color: #333;
    }

    /* --- BASE LAYOUT --- */
    body {
      background-color: var(--bg-color);
      color: var(--term-green);
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* --- SCANLINES & GLITCH FX --- */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      z-index: 2;
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
    }

    /* --- HEADER --- */
    header {
      width: 100%;
      padding: 40px 0;
      text-align: center;
      border-bottom: 2px solid var(--term-dim);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 3rem;
      letter-spacing: 10px;
      margin: 0;
      text-shadow: 0 0 10px var(--term-green);
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 1rem;
      color: var(--term-dim);
      letter-spacing: 2px;
      margin-top: 10px;
    }

    /* --- THE MANUAL (COLLAPSIBLE) --- */
    .manual-container {
      width: 95%;
      max-width: 1600px;
      border: 1px solid var(--term-dim);
      margin-bottom: 30px;
      background: #000;
    }

    details {
      padding: 10px;
      cursor: pointer;
    }

    summary {
      font-weight: bold;
      letter-spacing: 2px;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    summary::after { content: "[+]"; }
    details[open] summary::after { content: "[-]"; }

    .manual-content {
      padding: 20px;
      border-top: 1px dashed var(--term-dim);
      color: #ccc;
      line-height: 1.6;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }
    
    .manual-column h3 { color: var(--term-green); border-bottom: 1px solid var(--term-dim); padding-bottom: 5px; }
    .manual-column ul { list-style: square; padding-left: 20px; }

    /* --- MAIN ARMORY --- */
    .armory-controls {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }

    select {
      background: #000;
      color: var(--term-green);
      border: 1px solid var(--term-green);
      padding: 10px;
      font-family: inherit;
      text-transform: uppercase;
      cursor: pointer;
    }

    .chamber-grid {
      display: flex;
      gap: 20px;
      width: 95%;
      max-width: 1600px;
      flex: 1;
      margin-bottom: 40px;
    }

    .chamber {
      flex: 1;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: 0.3s;
      position: relative;
    }

    .chamber:hover {
      border-color: var(--term-green);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
    }

    .chamber.dragover {
      border-color: var(--bg-color);
      background: var(--term-green);
    }
    .chamber.dragover * { pointer-events: none; opacity: 0; }
    .chamber.dragover::after {
      content: "DROP PAYLOAD HERE";
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: #000;
      font-weight: bold;
      font-size: 1.5rem;
      opacity: 1;
    }

    .chamber-header {
      background: #111;
      border-bottom: 1px solid #333;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      letter-spacing: 2px;
    }

    .load-btn {
      cursor: pointer;
      font-size: 0.7rem;
      border: 1px solid #333;
      padding: 2px 6px;
      color: #666;
    }
    .load-btn:hover { color: var(--term-green); border-color: var(--term-green); }

    textarea {
      flex: 1;
      background: #000;
      color: #aaa;
      border: none;
      padding: 15px;
      resize: none;
      font-family: 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.4;
      outline: none;
      min-height: 400px;
    }

    textarea:focus {
      color: #fff;
      background: #080808;
    }

    /* --- TRIGGER MECHANISM --- */
    .trigger-zone {
      width: 100%;
      text-align: center;
      padding-bottom: 30px;
    }

    button#burnBtn {
      background: #000;
      color: var(--term-green);
      border: 2px solid var(--term-green);
      padding: 20px 60px;
      font-size: 1.5rem;
      letter-spacing: 5px;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.2s;
    }

    button#burnBtn:hover {
      background: var(--term-green);
      color: #000;
      box-shadow: 0 0 30px var(--term-green);
    }

    /* --- SYSTEM CONSOLE --- */
    .console-wrapper {
      width: 95%;
      max-width: 1600px;
      background: #000;
      border: 1px solid var(--term-dim);
      margin-bottom: 50px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    .console-header {
      background: var(--panel-bg);
      border-bottom: 1px solid var(--term-dim);
      padding: 5px 10px;
      font-size: 0.8rem;
      color: var(--term-dim);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    #log {
      height: 200px;
      overflow-y: scroll;
      padding: 10px;
      font-family: 'Consolas', monospace;
      font-size: 0.9rem;
      color: #888;
      display: flex;
      flex-direction: column;
    }

    /* Scrollbar styling */
    #log::-webkit-scrollbar { width: 8px; }
    #log::-webkit-scrollbar-track { background: #000; }
    #log::-webkit-scrollbar-thumb { background: #333; }
    #log::-webkit-scrollbar-thumb:hover { background: var(--term-green); }

    .log-line { margin-bottom: 2px; border-left: 2px solid transparent; padding-left: 5px; }
    .log-err { color: var(--alert-red); border-left-color: var(--alert-red); }
    .log-ok { color: var(--term-green); border-left-color: var(--term-green); }
    .log-warn { color: #ff0; border-left-color: #ff0; }
  </style>
</head>
<body>

  <header>
    <h1>Roulette Armory</h1>
    <div class="subtitle">/// UNIFIED PAYLOAD FABRICATION SYSTEM ///</div>
  </header>

  <div class="manual-container">
    <details>
      <summary>/// FIELD MANUAL (READ BEFORE FIRING)</summary>
      <div class="manual-content">
        <div class="manual-column">
          <h3>THE MECHANISM</h3>
          <p>The BadUSB is a revolver. The barrel holds three bullets. Just like Russian Roulette, except you control the bullet.</p>
          <ul>
            <li><strong>PLUG IN:</strong> Device fires the current chamber.</li>
            <li><strong>UNPLUG:</strong> Device cycles to the next chamber.</li>
            <li><strong>LED FLASH:</strong> Indicates chamber number (1, 2, or 3 blinks).</li>
            <li><strong>SOLID LIGHT:</strong> Armed. You have 3 seconds to unplug before it fires.</li>
          </ul>
        </div>
        <div class="manual-column">
          <h3>OPERATIONAL PROTOCOL</h3>
          <ul>
            <li><strong>LOAD:</strong> Drag .txt or .ino files into the chambers below.</li>
            <li><strong>COMPILE:</strong> Click the [FLASH FIRMWARE] button.</li>
            <li><strong>ARM:</strong> When prompted, plug in your Digispark.</li>
            <li><strong>NOTE:</strong> Total payload size must not exceed 1024 bytes.</li>
          </ul>
        </div>
      </div>
    </details>
  </div>

  <div class="armory-controls">
    <label>HARDWARE CONFIGURATION:</label>
    <select id="hwModel">
      <option value="roulette_single.hex">SINGLE LED (MODEL A / REV 2)</option>
      <option value="roulette_dual.hex">DUAL LED (MODEL B / REV 1)</option>
    </select>
  </div>

  <div class="chamber-grid">
    <div class="chamber" id="box1">
      <div class="chamber-header">
        <span>CHAMBER 01 // WINDOWS</span>
        <span class="load-btn" onclick="triggerFile('file1')">[LOAD FILE]</span>
        <input type="file" id="file1" hidden onchange="loadFile(this, 'c1')">
      </div>
      <textarea id="c1" placeholder="// DRAG FILE HERE OR TYPE CODE&#10;&#10;DELAY 1000&#10;GUI r&#10;DELAY 200&#10;STRING notepad&#10;ENTER"></textarea>
    </div>

    <div class="chamber" id="box2">
      <div class="chamber-header">
        <span>CHAMBER 02 // MAC</span>
        <span class="load-btn" onclick="triggerFile('file2')">[LOAD FILE]</span>
        <input type="file" id="file2" hidden onchange="loadFile(this, 'c2')">
      </div>
      <textarea id="c2" placeholder="// DRAG FILE HERE OR TYPE CODE&#10;&#10;DELAY 1000&#10;GUI SPACE&#10;DELAY 200&#10;STRING Terminal&#10;ENTER"></textarea>
    </div>

    <div class="chamber" id="box3">
      <div class="chamber-header">
        <span>CHAMBER 03 // LINUX</span>
        <span class="load-btn" onclick="triggerFile('file3')">[LOAD FILE]</span>
        <input type="file" id="file3" hidden onchange="loadFile(this, 'c3')">
      </div>
      <textarea id="c3" placeholder="// DRAG FILE HERE OR TYPE CODE&#10;&#10;DELAY 1000&#10;GUI&#10;DELAY 200&#10;STRING firefox&#10;ENTER"></textarea>
    </div>
  </div>

  <div class="trigger-zone">
    <button id="burnBtn">FLASH FIRMWARE</button>
  </div>

  <div class="console-wrapper">
    <div class="console-header">/// SYSTEM OUTPUT ///</div>
    <div id="log">
      <div class="log-line">[SYSTEM] READY. AWAITING PAYLOADS...</div>
    </div>
  </div>

<script>
// --- LOGGING ENGINE ---
function logMsg(msg, type='normal') {
  const logEl = document.getElementById('log');
  const line = document.createElement('div');
  
  let cssClass = 'log-line';
  if(type === 'error') cssClass += ' log-err';
  if(type === 'success') cssClass += ' log-ok';
  if(type === 'warn') cssClass += ' log-warn';
  
  line.className = cssClass;
  const time = new Date().toLocaleTimeString('en-US', { hour12: false });
  line.innerText = `[${time}] ${msg}`;
  
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

// --- DRAG & DROP LOGIC ---
['box1', 'box2', 'box3'].forEach((id) => {
  const el = document.getElementById(id);
  const textarea = el.querySelector('textarea');
  
  el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('dragover'); });
  el.addEventListener('dragleave', (e) => { e.preventDefault(); el.classList.remove('dragover'); });
  el.addEventListener('drop', (e) => {
    e.preventDefault();
    el.classList.remove('dragover');
    if (e.dataTransfer.files[0]) {
      logMsg("FILE DETECTED. LOADING...", 'warn');
      readFileInto(e.dataTransfer.files[0], textarea);
    }
  });
});

function triggerFile(id) { document.getElementById(id).click(); }
function loadFile(input, id) { 
  if(input.files[0]) {
    logMsg("FILE SELECTED. LOADING...", 'warn');
    readFileInto(input.files[0], document.getElementById(id)); 
  }
}
function readFileInto(file, textarea) {
  const reader = new FileReader();
  reader.onload = (e) => {
    textarea.value = e.target.result;
    logMsg("FILE LOADED SUCCESSFULLY.");
  };
  reader.readAsText(file);
}

// --- COMPILER ENGINE ---
const KEY_MAP = {
  'ENTER':0x28, 'ESC':0x29, 'BACKSPACE':0x2A, 'TAB':0x2B, 'SPACE':0x2C, 'MINUS':0x2D, 
  'EQUAL':0x2E, 'LEFT_BRACE':0x2F, 'RIGHT_BRACE':0x30, 'BACKSLASH':0x31, 'SEMICOLON':0x33, 
  'QUOTE':0x34, 'GRAVE':0x35, 'COMMA':0x36, 'PERIOD':0x37, 'SLASH':0x38, 'CAPS_LOCK':0x39, 
  'F1':0x3A, 'F2':0x3B, 'F3':0x3C, 'F4':0x3D, 'F5':0x3E, 'F6':0x3F, 'F7':0x40, 'F8':0x41, 
  'F9':0x42, 'F10':0x43, 'F11':0x44, 'F12':0x45, 'PRINTSCREEN':0x46, 'SCROLL_LOCK':0x47, 
  'PAUSE':0x48, 'INSERT':0x49, 'HOME':0x4A, 'PAGE_UP':0x4B, 'DELETE':0x4C, 'END':0x4D, 
  'PAGE_DOWN':0x4E, 'RIGHT':0x4F, 'LEFT':0x50, 'DOWN':0x51, 'UP':0x52, 'GUI':0xE3, 'WINDOWS':0xE3,
  'SHIFT':0xE1, 'ALT':0xE2, 'CTRL':0xE0
};

const ASCII_MAP = {
  'a':0x04,'b':0x05,'c':0x06,'d':0x07,'e':0x08,'f':0x09,'g':0x0A,'h':0x0B,'i':0x0C,'j':0x0D,
  'k':0x0E,'l':0x0F,'m':0x10,'n':0x11,'o':0x12,'p':0x13,'q':0x14,'r':0x15,'s':0x16,'t':0x17,
  'u':0x18,'v':0x19,'w':0x1A,'x':0x1B,'y':0x1C,'z':0x1D,'1':0x1E,'2':0x1F,'3':0x20,'4':0x21,
  '5':0x22,'6':0x23,'7':0x24,'8':0x25,'9':0x26,'0':0x27,' ':0x2C
};

function compileDucky(script) {
  const bytes = [];
  const lines = script.split('\n');
  for (let line of lines) {
    line = line.trim();
    if (!line || line.startsWith("REM") || line.startsWith("//") || line.startsWith("#")) continue;
    
    const parts = line.split(' ');
    const cmd = parts[0].toUpperCase();
    const args = parts.slice(1).join(' ');

    if (cmd === 'DELAY') {
      const ms = parseInt(args);
      bytes.push(0x01, (ms >> 8) & 0xFF, ms & 0xFF);
    } 
    else if (cmd === 'STRING') {
      bytes.push(0x02, args.length);
      for (let i = 0; i < args.length; i++) bytes.push(args.charCodeAt(i));
    }
    else if (cmd === 'GUI' || cmd === 'WINDOWS') {
      let key = 0;
      if (args && ASCII_MAP[args.toLowerCase()]) key = ASCII_MAP[args.toLowerCase()]; 
      else if (args && KEY_MAP[args.toUpperCase()]) key = KEY_MAP[args.toUpperCase()];
      bytes.push(0x02, 0x08, key); 
    }
    else if (KEY_MAP[cmd]) { bytes.push(0x02, 0x00, KEY_MAP[cmd]); }
  }
  bytes.push(0x00); 
  return bytes;
}

// --- PATCHER & FLASHER ---
function patchHex(hexString, payloadData) {
  const buffer = new Uint8Array(8192).fill(0xFF); 
  const lines = hexString.split('\n');
  for (let line of lines) {
    line = line.trim();
    if (line[0] !== ':') continue;
    const len = parseInt(line.substr(1, 2), 16);
    const addr = parseInt(line.substr(3, 4), 16);
    const type = parseInt(line.substr(7, 2), 16);
    if (type === 0) { 
      for (let i = 0; i < len; i++) { buffer[addr + i] = parseInt(line.substr(9 + i * 2, 2), 16); }
    }
  }

  let magicIdx = -1;
  for (let i = 0; i < buffer.length - 4; i++) {
    if (buffer[i]===0xCA && buffer[i+1]===0xFE && buffer[i+2]===0xBA && buffer[i+3]===0xBE) {
      magicIdx = i; break;
    }
  }

  if (magicIdx === -1) throw new Error("TEMPLATE CORRUPTED: MAGIC HEADER MISSING");

  let dataStart = magicIdx + 10; 
  let currentOffset = 10;
  
  const totalSize = 10 + payloadData.c1.length + payloadData.c2.length + payloadData.c3.length;
  if (totalSize > 1024) throw new Error("PAYLOAD OVERFLOW: " + totalSize + "/1024 BYTES");

  // Inject C1
  buffer[magicIdx + 4] = (currentOffset >> 8) & 0xFF;
  buffer[magicIdx + 5] = (currentOffset) & 0xFF;
  for(let b of payloadData.c1) buffer[magicIdx + dataStart++] = b;
  currentOffset += payloadData.c1.length;
  
  // Inject C2
  buffer[magicIdx + 6] = (currentOffset >> 8) & 0xFF;
  buffer[magicIdx + 7] = (currentOffset) & 0xFF;
  for(let b of payloadData.c2) buffer[magicIdx + dataStart++] = b;
  currentOffset += payloadData.c2.length;
  
  // Inject C3
  buffer[magicIdx + 8] = (currentOffset >> 8) & 0xFF;
  buffer[magicIdx + 9] = (currentOffset) & 0xFF;
  for(let b of payloadData.c3) buffer[magicIdx + dataStart++] = b;
  
  return buffer;
}

document.getElementById('burnBtn').addEventListener('click', async () => {
  const hw = document.getElementById('hwModel').value;
  
  try {
    if (!navigator.usb) throw new Error("WEBUSB NOT DETECTED. USE CHROME/EDGE.");
    
    logMsg("COMPILING DUCKYSCRIPTS...");
    
    const payloads = {
      c1: compileDucky(document.getElementById('c1').value),
      c2: compileDucky(document.getElementById('c2').value),
      c3: compileDucky(document.getElementById('c3').value)
    };
    
    logMsg("FETCHING FIRMWARE TEMPLATE: " + hw);
    const resp = await fetch(hw);
    if (!resp.ok) throw new Error("TEMPLATE MISSING: " + hw);
    const hexText = await resp.text();
    
    logMsg("PATCHING HEX BINARY...");
    const firmBuffer = patchHex(hexText, payloads);
    
    logMsg("SEARCHING FOR DIGISPARK... (PLUG IT IN NOW)");
    const device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x16d0, productId: 0x0753 }] });
    
    const client = new Micronucleus(device);
    
    logMsg("DEVICE FOUND. FLASHING FIRMWARE...", 'warn');
    await client.upload(firmBuffer);
    
    logMsg("FLASH COMPLETE. DISENGAGE DEVICE.", 'success');
    
  } catch (e) {
    logMsg("FATAL ERROR: " + e.message, 'error');
  }
});
</script>
</body>
</html>

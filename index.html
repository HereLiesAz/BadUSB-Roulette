<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BADUSB ROULETTE</title>
  <script src="https://cdn.jsdelivr.net/gh/skandhurkat/micronucleus-web@master/lib/micronucleus.js"></script>
  <style>
    :root {
      --bg-color: #050505;
      --term-green: #00ff41;
      --term-dim: #008f11;
      --alert-red: #ff0000;
      --panel-bg: #0a0a0a;
      --border-color: #333;
    }

    body {
      background-color: var(--bg-color);
      color: var(--term-green);
      font-family: 'Consolas', 'Monaco', monospace;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      width: 100%;
      padding: 20px 0;
      text-align: center;
      border-bottom: 1px solid var(--term-dim);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2rem;
      letter-spacing: 5px;
      margin: 0;
      text-transform: uppercase;
    }

    .subtitle { font-size: 0.8rem; color: var(--term-dim); margin-top: 5px; }

    #winWarning {
      display: none;
      width: 95%; max-width: 800px;
      border: 1px solid var(--alert-red);
      background: rgba(50, 0, 0, 0.5);
      margin-bottom: 20px;
      padding: 10px; font-size: 0.8rem; color: var(--alert-red);
    }
    #winWarning a { color: #fff; text-decoration: underline; }

    .armory-controls {
      display: flex; gap: 20px; margin-bottom: 20px;
      align-items: center; flex-wrap: wrap; justify-content: center;
      font-size: 0.9rem;
    }

    select, .file-upload {
      background: #000; color: var(--term-green);
      border: 1px solid #333; padding: 8px;
      font-family: inherit; cursor: pointer;
    }
    .file-upload { color: #888; border-style: dashed; }
    .file-upload:hover { border-color: var(--term-green); color: var(--term-green); }
    input[type="file"] { display: none; }

    .chamber-grid {
      display: flex; gap: 15px; width: 95%; max-width: 1600px;
      flex: 1; margin-bottom: 30px;
    }

    .chamber {
      flex: 1; background: var(--panel-bg);
      border: 1px solid var(--border-color);
      display: flex; flex-direction: column;
    }

    .chamber-header {
      background: #111; border-bottom: 1px solid #333;
      padding: 8px; display: flex;
      justify-content: space-between; align-items: center;
      font-size: 0.8rem;
    }
    
    .mutation-select {
        background: #000; color: #666;
        border: 1px solid #333; font-size: 0.7rem;
    }

    textarea {
      flex: 1; background: #000; color: #ccc;
      border: none; padding: 10px; resize: none;
      font-family: 'Consolas', monospace; font-size: 13px;
      line-height: 1.4; outline: none; min-height: 300px;
    }

    .trigger-zone { width: 100%; text-align: center; padding-bottom: 20px; }
    
    button#burnBtn {
      background: #000; color: var(--term-green);
      border: 2px solid var(--term-green); padding: 15px 40px;
      font-size: 1.2rem; letter-spacing: 2px;
      cursor: pointer; text-transform: uppercase;
    }
    button#burnBtn:hover { background: var(--term-green); color: #000; }

    .console-wrapper {
      width: 95%; max-width: 1600px;
      background: #000; border: 1px solid #333;
      margin-bottom: 40px;
    }
    .console-header {
      background: #111; border-bottom: 1px solid #333;
      padding: 5px 10px; font-size: 0.75rem; color: #666;
    }
    #log {
      height: 300px; overflow-y: scroll; padding: 10px;
      font-family: 'Consolas', monospace; font-size: 0.85rem;
      color: #aaa; white-space: pre-wrap;
    }
    .log-line { border-bottom: 1px solid #111; padding: 2px 0; }
    .log-err { color: var(--alert-red); }
    .log-ok { color: var(--term-green); }
    .log-warn { color: #ff0; }
    .log-debug { color: #555; }
  </style>
</head>
<body>

  <header>
    <h1>BadUSB Roulette</h1>
    <div class="subtitle">/// UNIFIED PAYLOAD SYSTEM ///</div>
  </header>

  <div id="winWarning">
    <strong>WINDOWS DETECTED:</strong> WebUSB requires the <strong>WinUSB</strong> driver via <a href="https://zadig.akeo.ie/" target="_blank">Zadig</a>.
  </div>

  <div class="armory-controls">
    <label>TARGET:</label>
    <select id="hwModel">
      <option value="roulette_single.hex">SINGLE LED</option>
      <option value="roulette_dual.hex">DUAL LED</option>
    </select>
    
    <label class="file-upload">
      [ MANUAL LOAD .HEX ]
      <input type="file" id="customHex" accept=".hex">
    </label>
  </div>

  <div class="chamber-grid">
    <div class="chamber">
      <div class="chamber-header">
        C1
        <select class="mutation-select" onchange="mutate(this, 'c1')">
          <option value="" disabled selected>MUTATE</option>
          <option value="WIN">WIN</option>
          <option value="MAC">MAC</option>
          <option value="LINUX">LINUX</option>
        </select>
      </div>
      <textarea id="c1" placeholder="// WINDOWS PAYLOAD&#10;DELAY 1000&#10;GUI r&#10;DELAY 200&#10;STRING notepad&#10;ENTER"></textarea>
    </div>
    <div class="chamber">
      <div class="chamber-header">
        C2
        <select class="mutation-select" onchange="mutate(this, 'c2')">
          <option value="" disabled selected>MUTATE</option>
          <option value="WIN">WIN</option>
          <option value="MAC">MAC</option>
          <option value="LINUX">LINUX</option>
        </select>
      </div>
      <textarea id="c2" placeholder="// MAC PAYLOAD&#10;DELAY 1000&#10;GUI SPACE&#10;DELAY 200&#10;STRING Terminal&#10;ENTER"></textarea>
    </div>
    <div class="chamber">
      <div class="chamber-header">
        C3
        <select class="mutation-select" onchange="mutate(this, 'c3')">
          <option value="" disabled selected>MUTATE</option>
          <option value="WIN">WIN</option>
          <option value="MAC">MAC</option>
          <option value="LINUX">LINUX</option>
        </select>
      </div>
      <textarea id="c3" placeholder="// LINUX PAYLOAD&#10;DELAY 1000&#10;GUI&#10;DELAY 200&#10;STRING firefox&#10;ENTER"></textarea>
    </div>
  </div>

  <div class="trigger-zone">
    <button id="burnBtn">FLASH FIRMWARE</button>
  </div>

  <div class="console-wrapper">
    <div class="console-header">/// SERIAL LOG ///</div>
    <div id="log"></div>
  </div>

<script>
if (navigator.userAgent.indexOf("Win") != -1) {
  document.getElementById('winWarning').style.display = 'block';
}

function logMsg(msg, type='normal') {
  const logEl = document.getElementById('log');
  const line = document.createElement('div');
  line.className = 'log-line ' + (type === 'error' ? 'log-err' : type === 'success' ? 'log-ok' : type === 'debug' ? 'log-debug' : '');
  const timestamp = new Date().toLocaleTimeString('en-US',{hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit', fractionalSecondDigits: 3});
  line.innerText = `[${timestamp}] ${msg}`;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

const KEY_MAP = {
  'ENTER':0x28, 'ESC':0x29, 'BACKSPACE':0x2A, 'TAB':0x2B, 'SPACE':0x2C, 'MINUS':0x2D, 
  'EQUAL':0x2E, 'LEFT_BRACE':0x2F, 'RIGHT_BRACE':0x30, 'BACKSLASH':0x31, 'SEMICOLON':0x33, 
  'QUOTE':0x34, 'GRAVE':0x35, 'COMMA':0x36, 'PERIOD':0x37, 'SLASH':0x38, 'CAPS_LOCK':0x39, 
  'F1':0x3A, 'F2':0x3B, 'F3':0x3C, 'F4':0x3D, 'F5':0x3E, 'F6':0x3F, 'F7':0x40, 'F8':0x41, 
  'F9':0x42, 'F10':0x43, 'F11':0x44, 'F12':0x45, 'PRINTSCREEN':0x46, 'SCROLL_LOCK':0x47, 
  'PAUSE':0x48, 'INSERT':0x49, 'HOME':0x4A, 'PAGE_UP':0x4B, 'DELETE':0x4C, 'END':0x4D, 
  'PAGE_DOWN':0x4E, 'RIGHT':0x4F, 'LEFT':0x50, 'DOWN':0x51, 'UP':0x52, 'GUI':0xE3, 'WINDOWS':0xE3,
  'COMMAND':0xE3, 'SHIFT':0xE1, 'ALT':0xE2, 'CTRL':0xE0
};

const ASCII_MAP = {
  'a':0x04,'b':0x05,'c':0x06,'d':0x07,'e':0x08,'f':0x09,'g':0x0A,'h':0x0B,'i':0x0C,'j':0x0D,
  'k':0x0E,'l':0x0F,'m':0x10,'n':0x11,'o':0x12,'p':0x13,'q':0x14,'r':0x15,'s':0x16,'t':0x17,
  'u':0x18,'v':0x19,'w':0x1A,'x':0x1B,'y':0x1C,'z':0x1D,'1':0x1E,'2':0x1F,'3':0x20,'4':0x21,
  '5':0x22,'6':0x23,'7':0x24,'8':0x25,'9':0x26,'0':0x27,' ':0x2C
};

function compileDucky(script) {
  const bytes = [];
  const lines = script.split('\n');
  for (let line of lines) {
    line = line.trim();
    if (!line || line.startsWith("REM") || line.startsWith("//") || line.startsWith("#")) continue;
    const parts = line.split(' ');
    const cmd = parts[0].toUpperCase();
    const args = parts.slice(1).join(' ');
    if (cmd === 'DELAY') {
      const ms = parseInt(args);
      bytes.push(0x01, (ms >> 8) & 0xFF, ms & 0xFF);
    } else if (cmd === 'STRING') {
      for (let i = 0; i < args.length; i += 255) {
        const chunk = args.substring(i, Math.min(i + 255, args.length));
        bytes.push(0x03, chunk.length); 
        for (let c = 0; c < chunk.length; c++) bytes.push(chunk.charCodeAt(c));
      }
    } else if (cmd === 'GUI' || cmd === 'WINDOWS' || cmd === 'COMMAND') {
      let key = 0;
      if (args && ASCII_MAP[args.toLowerCase()]) key = ASCII_MAP[args.toLowerCase()]; 
      else if (args && KEY_MAP[args.toUpperCase()]) key = KEY_MAP[args.toUpperCase()];
      bytes.push(0x02, 0x08, key); 
    } else if (KEY_MAP[cmd]) { 
      bytes.push(0x02, 0x00, KEY_MAP[cmd]); 
    }
  }
  bytes.push(0x00); 
  return bytes;
}

function patchHex(hexString, payloadData) {
  const buffer = new Uint8Array(8192).fill(0xFF); 
  const lines = hexString.split('\n');
  for (let line of lines) {
    line = line.trim();
    if (line[0] !== ':') continue;
    const len = parseInt(line.substr(1, 2), 16);
    const addr = parseInt(line.substr(3, 4), 16);
    const type = parseInt(line.substr(7, 2), 16);
    if (type === 0) { 
      for (let i = 0; i < len; i++) { buffer[addr + i] = parseInt(line.substr(9 + i * 2, 2), 16); }
    }
  }
  let magicIdx = -1;
  for (let i = 0; i < buffer.length - 4; i++) {
    if (buffer[i]===0xCA && buffer[i+1]===0xFE && buffer[i+2]===0xBA && buffer[i+3]===0xBE) {
      magicIdx = i; break;
    }
  }
  if (magicIdx === -1) throw new Error("TEMPLATE INVALID: MAGIC HEADER NOT FOUND");
  
  let currentOffset = 10;
  function inject(payload, offH_idx, offL_idx) {
    buffer[magicIdx + offH_idx] = (currentOffset >> 8) & 0xFF;
    buffer[magicIdx + offL_idx] = (currentOffset) & 0xFF;
    if (payload.length <= 1) return; 
    if (magicIdx + currentOffset + payload.length >= buffer.length) throw new Error("PAYLOAD TOO LARGE");
    let writePtr = magicIdx + currentOffset;
    for(let b of payload) { buffer[writePtr++] = b; }
    currentOffset += payload.length;
  }
  inject(payloadData.c1, 4, 5);
  inject(payloadData.c2, 6, 7);
  inject(payloadData.c3, 8, 9);
  return buffer;
}

function mutate(selector, targetId) {
  const mode = selector.value;
  const area = document.getElementById(targetId);
  let script = area.value;
  if (!script) return;
  script = script
    .replace(/GUI r\b/gi, '###RUN###').replace(/GUI SPACE\b/gi, '###RUN###').replace(/ALT F2\b/gi, '###RUN###')
    .replace(/COMMAND\b/gi, '###GUI###').replace(/WINDOWS\b/gi, '###GUI###').replace(/GUI\b/gi, '###GUI###');
  switch(mode) {
    case 'WIN': script = script.replace(/###RUN###/g, 'GUI r').replace(/###GUI###/g, 'GUI').replace(/OPTION\b/gi, 'ALT'); break;
    case 'MAC': script = script.replace(/###RUN###/g, 'GUI SPACE').replace(/###GUI###/g, 'COMMAND').replace(/ALT\b/gi, 'OPTION').replace(/CTRL\b/gi, 'COMMAND'); break;
    case 'LINUX': script = script.replace(/###RUN###/g, 'ALT F2').replace(/###GUI###/g, 'GUI').replace(/COMMAND\b/gi, 'CTRL').replace(/OPTION\b/gi, 'ALT'); break;
  }
  area.value = script;
  selector.selectedIndex = 0; 
}

// --- APP LOGIC ---
let customHexData = null;
document.getElementById('customHex').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (file) {
    customHexData = await file.text();
    logMsg(`FILE LOADED: ${file.name} (${file.size} bytes)`, 'success');
  }
});

async function acquireFirmware(filename) {
  if (customHexData) return customHexData;

  const firmPath = `firmware/${filename}`;
  const targetUrl = `${firmPath}?t=${Date.now()}`;
  
  // LOG THE EXACT PATH WE ARE TRYING
  const fullPath = new URL(firmPath, document.baseURI).href;
  logMsg(`[SYS] Current Page: ${document.baseURI}`, 'debug');
  logMsg(`[ACQ] Fetching: ${fullPath}`, 'debug');

  try {
    const resp = await fetch(targetUrl);
    if (resp.status === 404) {
      logMsg(`[ERR] 404 Not Found.`, 'error');
      logMsg(`[HINT] 1. Did the 'Deploy System' action finish?`, 'warn');
      logMsg(`[HINT] 2. Did the build fail? Check Actions tab.`, 'warn');
      throw new Error("Firmware file missing from deployment.");
    }
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    logMsg(`[ACQ] Success.`, 'success');
    return await resp.text();
  } catch (e) {
    throw new Error(`Download Failed: ${e.message}`);
  }
}

document.getElementById('burnBtn').addEventListener('click', async () => {
  const hw = document.getElementById('hwModel').value;
  try {
    if (!navigator.usb) throw new Error("WebUSB not supported");
    logMsg("--- STARTING SEQUENCE ---");
    
    const payloads = {
      c1: compileDucky(document.getElementById('c1').value),
      c2: compileDucky(document.getElementById('c2').value),
      c3: compileDucky(document.getElementById('c3').value)
    };
    logMsg("[CMP] Compilation Complete", 'success');
    
    const hexText = await acquireFirmware(hw);
    logMsg(`[HEX] Firmware loaded (${hexText.length} bytes)`, 'success');
    
    const firmBuffer = patchHex(hexText, payloads);
    logMsg("[PAT] Firmware Patched Successfully", 'success');
    
    logMsg("[USB] Requesting Device...", 'warn');
    const device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x16d0, productId: 0x0753 }] });
    const client = new Micronucleus(device);
    
    logMsg("[USB] Flashing...", 'warn');
    await client.upload(firmBuffer);
    logMsg("--- FLASH COMPLETE ---", 'success');
    
  } catch (e) {
    logMsg(`[FATAL] ${e.message}`, 'error');
  }
});
</script>
</body>
</html>
